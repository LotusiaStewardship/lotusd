on:
  workflow_call:
    inputs:
      version:
        description: "The version to package and release"
        required: true
        type: string

# Global defaults for all jobs
defaults:
  run:
    shell: bash

jobs:
  # Package artifacts
  package-artifacts:
    name: ðŸ“¦ Package Artifacts
    runs-on: [ ubuntu-latest ]
    outputs:
      package_status: ${{ job.status }}

    steps:
    - name: Create artifacts directory
      run: |
        mkdir -p ./artifacts
        mkdir -p ./artifacts/kernels

    # Download all artifacts
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-${{ inputs.version }}"
        path: ./artifacts/
        merge-multiple: true

    # Make sure all binaries are executable
    - name: Set permissions
      run: |
        chmod +x ./artifacts/*

    # Create tarball of all binaries
    - name: Create tarball
      run: |
        cd ./artifacts

        # Create directory structure
        mkdir -p gpu-miner-package/kernels

        # Copy binaries
        cp lotus* gpu-miner-package/

        # Copy kernels
        if [ -d "./kernels" ]; then
          cp -r kernels/* gpu-miner-package/kernels/ || true
        fi

        # Create tarball
        tar -czvf lotus-binaries-${{ inputs.version }}.tar.gz gpu-miner-package/

        # Clean up
        rm -rf gpu-miner-package

    # Upload combined artifact
    - name: Upload combined artifacts
      uses: actions/upload-artifact@v4
      with:
        name: lotus-binaries-${{ inputs.version }}
        path: ./artifacts/lotus-binaries-*.tar.gz
        retention-days: 14

  # Create the Git tag
  create-tag:
    name: ðŸ·ï¸ Create Git Tag
    runs-on: [ ubuntu ]
    outputs:
      tag_created: ${{ steps.create-tag.outputs.tag_created }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: master
        fetch-depth: 0

    - name: Check if tag exists
      id: check-tag
      run: |
        VERSION="${{ inputs.version }}"
        if git ls-remote --tags origin | grep -q "refs/tags/v$VERSION"; then
          echo "should_tag=false" >> $GITHUB_OUTPUT
          echo "Tag v$VERSION already exists"
        else
          echo "should_tag=true" >> $GITHUB_OUTPUT
          echo "Tag v$VERSION does not exist yet"
        fi

    - name: Create and push tag
      id: create-tag
      if: steps.check-tag.outputs.should_tag == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        VERSION="${{ inputs.version }}"
        
        # Fetch the latest changes first
        git fetch origin master
        
        # Make sure we're on the latest master with rebase
        git checkout master
        git reset --hard origin/master
        
        # Create and push the tag
        git tag -a "v$VERSION" -m "Release v$VERSION"
        git push origin "v$VERSION"
        
        echo "tag_created=true" >> $GITHUB_OUTPUT
        echo "Tag v$VERSION created and pushed successfully"

  # Create the GitHub release
  publish-release:
    name: ðŸŽ Publish GitHub Release
    needs: [ create-tag, package-artifacts ]
    runs-on: ubuntu-latest
    if: always() && needs.create-tag.result == 'success' && needs.package-artifacts.result == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: master
        fetch-depth: 0

    # Download artifacts
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: lotus-binaries-${{ inputs.version }}
        path: ./artifacts

    # Generate release notes with key information
    - name: Generate release notes
      id: generate-notes
      run: |
        VERSION="${{ inputs.version }}"
        REPO_OWNER_LC=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')

        # Get commit history for changelog
        PREV_TAG=$(git describe --tags --abbrev=0 --exclude="v${VERSION}" 2>/dev/null || echo "")
        if [ -z "$PREV_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s by %an" -10)
        else
          CHANGELOG=$(git log --pretty=format:"- %s by %an" ${PREV_TAG}..HEAD)
        fi

        # Create release notes
        cat > release_notes.md << EOF
        # ðŸš€ Lotus Core v${VERSION} Release

        ![Lotus Logo](https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/master/share/pixmaps/lotus64.png)

        ## ðŸ“¦ Binaries and Docker Images

        ### Binary Packages
        * [Combined Binary Package](https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/lotus-binaries-${VERSION}.tar.gz) - Complete package of all Lotus binaries

        ### Docker Images
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-node:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-node) - Main Lotus daemon
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-cli:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-cli) - Command-line interface
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-seeder:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-seeder) - Network seeder
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-tx:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-tx) - Transaction utility
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-wallet:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-wallet) - Wallet utility
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-qt:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-qt) - Desktop GUI wallet
        * [\`ghcr.io/${REPO_OWNER_LC}/lotus-gpu-miner:${VERSION}\`](https://github.com/${GITHUB_REPOSITORY}/pkgs/container/lotus-gpu-miner) - GPU Miner

        ## ðŸ” What's Changed

        [View all changes](https://github.com/${GITHUB_REPOSITORY}/compare/${PREV_TAG}...v${VERSION})

        ### Changelog
        ${CHANGELOG}

        ## ðŸ’¡ Installation Instructions

        ### Docker Installation
        \`\`\`bash
        # Pull the Lotus node image
        docker pull ghcr.io/${REPO_OWNER_LC}/lotus-node:${VERSION}

        # Run a Lotus node
        docker run -d --name lotus-node -p 10605:10605 -p 10604:10604 -v lotus-data:/root/.lotus ghcr.io/${REPO_OWNER_LC}/lotus-node:${VERSION}
        \`\`\`

        ### GPU Miner Installation
        \`\`\`bash
        # Pull the GPU miner image
        docker pull ghcr.io/${REPO_OWNER_LC}/lotus-gpu-miner:${VERSION}

        # Run the GPU miner (requires NVIDIA runtime)
        docker run --gpus all -d --name lotus-gpu-miner ghcr.io/${REPO_OWNER_LC}/lotus-gpu-miner:${VERSION} --pool <your-pool-url> --user <your-wallet-address>
        \`\`\`

        ## ðŸ“‹ System Requirements
        - **OS**: Ubuntu 22.04 or newer, Windows 10+, macOS 11+
        - **RAM**: 4GB minimum, 8GB recommended
        - **Storage**: 16GB minimum, SSD recommended
        - **GPU Mining**: NVIDIA GPU with CUDA support

        ## ðŸ”— Additional Resources
        - [Official Website](https://lotusia.org)
        - [Documentation](https://docs.lotusia.org)
        - [GitHub Repository](https://github.com/${GITHUB_REPOSITORY})
        - [Issue Tracker](https://github.com/${GITHUB_REPOSITORY}/issues)

        ---
        *This release was automatically generated by the Lotus CI system on $(date -u "+%Y-%m-%d")*
        EOF

        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        echo "$(cat release_notes.md)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    # Create GitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ inputs.version }}
        name: Lotus Core v${{ inputs.version }}
        body: ${{ steps.generate-notes.outputs.release_notes }}
        files: ./artifacts/lotus-binaries-*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: write
  packages: write
