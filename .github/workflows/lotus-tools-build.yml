name: ðŸ”§ Lotus Tools Build

on:
  workflow_call:
    inputs:
      version:
        description: "The version to build"
        required: true
        type: string

jobs:
  build-lotus-seeder:
    name: ðŸŒ± Build lotus-seeder
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ job.status }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: master

    - name: Setup Docker
      uses: docker/setup-buildx-action@v2
      with:
        install: true

    - name: Docker registry login
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set repository owner
      run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

    - name: Build container
      run: |
        docker build -t ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:${{ inputs.version }} \
          -f dockerfiles/Dockerfile.lotus-seeder .

    - name: Extract binary
      run: |
        mkdir -p ./artifacts
        container_id=$(docker create ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:${{ inputs.version }})
        docker cp $container_id:/opt/lotus/bin/lotus-seeder ./artifacts/
        docker rm $container_id

    - name: Tag and push to registry
      if: github.event_name != 'pull_request'
      run: |
        docker tag ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:${{ inputs.version }} \
          ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:sha-${{ github.sha }}
        docker tag ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:${{ inputs.version }} \
          ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:latest
          
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:${{ inputs.version }}
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:sha-${{ github.sha }}
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-seeder:latest

    - name: Upload artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: lotus-seeder-${{ inputs.version }}
        path: ./artifacts/lotus-seeder
        retention-days: 14

  build-lotus-wallet:
    name: ðŸ’¼ Build lotus-wallet
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ job.status }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        ref: master

    - name: Setup Docker
      uses: docker/setup-buildx-action@v2
      with:
        install: true

    - name: Docker registry login
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set repository owner
      run: echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

    - name: Build container
      run: |
        docker build -t ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:${{ inputs.version }} \
          -f dockerfiles/Dockerfile.lotus-wallet .

    - name: Extract binary
      run: |
        mkdir -p ./artifacts
        container_id=$(docker create ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:${{ inputs.version }})
        docker cp $container_id:/opt/lotus/bin/lotus-wallet ./artifacts/
        docker rm $container_id

    - name: Tag and push to registry
      if: github.event_name != 'pull_request'
      run: |
        docker tag ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:${{ inputs.version }} \
          ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:sha-${{ github.sha }}
        docker tag ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:${{ inputs.version }} \
          ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:latest
          
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:${{ inputs.version }}
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:sha-${{ github.sha }}
        docker push ghcr.io/${{ env.REPO_OWNER_LC }}/lotus-wallet:latest

    - name: Upload artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: lotus-wallet-${{ inputs.version }}
        path: ./artifacts/lotus-wallet
        retention-days: 14
