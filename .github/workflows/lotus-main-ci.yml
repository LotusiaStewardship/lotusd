name: 🌸 Lotus Main CI

# Add concurrency to prevent multiple workflows running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # First, check the current version
  version-management:
    name: 📊 Version Check
    uses: ./.github/workflows/lotus-version-management.yml
    secrets: inherit
    
  # Build all components in parallel with better naming
  build-core:
    name: 🏗️ Build Core
    needs: [version-management]
    if: |
      always() && 
      (needs.version-management.outputs.should_bump == 'false' || 
       needs.version-management.outputs.version_bumped == 'true')
    uses: ./.github/workflows/lotus-core-build.yml
    with:
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

  build-tools:
    name: 🔧 Build Tools
    needs: [version-management]
    if: |
      always() && 
      (needs.version-management.outputs.should_bump == 'false' || 
       needs.version-management.outputs.version_bumped == 'true')
    uses: ./.github/workflows/lotus-tools-build.yml
    with:
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

  build-gui:
    name: 🖥️ Build GUI
    needs: [version-management]
    if: |
      always() && 
      (needs.version-management.outputs.should_bump == 'false' || 
       needs.version-management.outputs.version_bumped == 'true')
    uses: ./.github/workflows/lotus-gui-build.yml
    with:
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

  build-miner:
    name: ⛏️ Build Miner
    needs: [version-management]
    if: |
      always() && 
      (needs.version-management.outputs.should_bump == 'false' || 
       needs.version-management.outputs.version_bumped == 'true')
    uses: ./.github/workflows/lotus-miner-build.yml
    with:
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

  # Revert version bump if any builds failed
  revert-version:
    name: ⏮️ Revert Version
    needs: [version-management, build-core, build-tools, build-gui, build-miner]
    if: |
      always() && 
      needs.version-management.outputs.version_bumped == 'true' &&
      (needs.build-core.result == 'failure' || 
       needs.build-tools.result == 'failure' || 
       needs.build-gui.result == 'failure' || 
       needs.build-miner.result == 'failure')
    uses: ./.github/workflows/lotus-version-revert.yml
    with:
      current_version: ${{ needs.version-management.outputs.version }}
      build_failures: ${{ needs.build-core.result == 'failure' || needs.build-tools.result == 'failure' || needs.build-gui.result == 'failure' || needs.build-miner.result == 'failure' }}
    secrets: inherit

  # Finally, package and release all artifacts
  create-release:
    name: 🚀 Create Release
    needs: [version-management, build-core, build-tools, build-gui, build-miner, revert-version]
    if: |
      always() && 
      github.ref == 'refs/heads/master' && 
      github.event_name == 'push' &&
      needs.build-core.result == 'success' &&
      needs.build-tools.result == 'success' &&
      needs.build-gui.result == 'success' &&
      needs.build-miner.result == 'success' &&
      (needs.revert-version.result == 'skipped' || needs.revert-version.result == 'success')
    uses: ./.github/workflows/lotus-release.yml
    with:
      version: ${{ needs.version-management.outputs.version }}
    secrets: inherit

# Add permissions at the top level
permissions:
  contents: write
  packages: write 